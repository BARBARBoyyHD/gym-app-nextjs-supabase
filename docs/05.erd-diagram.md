# ERD — FitTrack (Gym Membership & Video Course Platform)

Dokumen ini berisi **Entity-Relationship Diagram (ERD)** dalam format Markdown untuk proyek FitTrack.
Berikut meliputi: diagram (Mermaid), skema tabel, kolom, relasi, indeks, dan rekomendasi RLS & constraints.

---

## 1. Mermaid ERD (visual)

```mermaid
+----------------------+
|       users          |
+----------------------+
| id (uuid) PK         |
| full_name (text)     |
| email (text)         |
| phone (text)         |
| joined_date (date)   |
| created_at (timestamptz)
+----------------------+
            |
            | 1-to-many
            v
+----------------------+
|    memberships       |
+----------------------+
| id (uuid) PK         |
| user_id (uuid) FK --> users.id
| plan_id (int) FK --> membership_plans.id
| start_date (date)    |
| end_date (date)      |
| status (text)        |
| created_at (timestamptz)
+----------------------+
            |
            | 1-to-1 / 1-to-many (optional)
            v
+----------------------+
|      payments        |
+----------------------+
| id (uuid) PK         |
| user_id (uuid) FK --> users.id
| membership_id (uuid) FK --> memberships.id
| amount numeric(12,2) |
| method (text)        |
| receipt_url (text)   |
| paid_at (timestamptz)|
| created_at (timestamptz)
+----------------------+

+---------------------------+
|   membership_plans        |
+---------------------------+
| id (serial) PK            |
| name (text)               |
| price numeric(12,2)       |
| duration_days (integer)   |
| description (text)        |
| created_at (timestamptz)  |
+---------------------------+

+---------------------------+
|         courses           |
+---------------------------+
| id (serial) PK            |
| title (text)              |
| description (text)        |
| category (text)           |
| video_embed_url (text)    |
| thumbnail_url (text)      |
| created_at (timestamptz)  |
+---------------------------+

```

> Catatan: Mermaid ERD di atas menggambarkan relasi utama. Beberapa viewer Markdown (GitHub, VSCode + extensions) mendukung rendering mermaid.

---

## 2. Tabel & Kolom (Detail)

### `users` (member records only)

* `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
* `full_name` TEXT NOT NULL
* `email` TEXT
* `phone` TEXT
* `joined_date` DATE
* `created_at` TIMESTAMP WITH TIME ZONE DEFAULT now()

### `membership_plans`

* `id` SERIAL PRIMARY KEY
* `name` TEXT NOT NULL
* `price` NUMERIC(12,2) NOT NULL DEFAULT 0
* `duration_days` INTEGER NOT NULL -- duration in days
* `description` TEXT
* `created_at` TIMESTAMP WITH TIME ZONE DEFAULT now()

### `memberships`

* `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
* `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
* `plan_id` INTEGER REFERENCES membership_plans(id) ON DELETE SET NULL
* `start_date` DATE NOT NULL
* `end_date` DATE NOT NULL
* `status` TEXT CHECK (status IN ('active','expired')) NOT NULL
* `created_at` TIMESTAMP WITH TIME ZONE DEFAULT now()

### `courses`

* `id` SERIAL PRIMARY KEY
* `title` TEXT NOT NULL
* `description` TEXT
* `category` TEXT
* `video_embed_url` TEXT NOT NULL
* `thumbnail_url` TEXT
* `created_at` TIMESTAMP WITH TIME ZONE DEFAULT now()

### `payments`

* `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
* `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
* `membership_id` UUID REFERENCES memberships(id) ON DELETE SET NULL
* `amount` NUMERIC(12,2) NOT NULL
* `method` TEXT
* `receipt_url` TEXT
* `paid_at` TIMESTAMP WITH TIME ZONE
* `created_at` TIMESTAMP WITH TIME ZONE DEFAULT now()

---

## 3. Relasi Utama

* `users` 1 — * `memberships` (satu user bisa punya banyak riwayat membership)
* `membership_plans` 1 — * `memberships` (satu plan bisa dipakai oleh banyak memberships)
* `memberships` 1 — * `payments` (satu membership dapat memiliki beberapa pembayaran/bukti)
* `users` 1 — * `payments` (history pembayaran per user)
* `courses` berdiri sendiri; akses diatur oleh business rule (mis. hanya member aktif dapat mengakses)

---

## 4. Indexes & Performance Recommendations

* `CREATE INDEX idx_users_email ON users(email);` -- untuk pencarian cepat
* `CREATE INDEX idx_memberships_user_id ON memberships(user_id);`
* `CREATE INDEX idx_memberships_end_date ON memberships(end_date);` -- untuk query expired/active
* `CREATE INDEX idx_courses_category ON courses(category);`
* Untuk reporting, tambahkan partial index pada memberships active:

  ```sql
  CREATE INDEX idx_memberships_active ON memberships(user_id) WHERE status = 'active';
  ```

---

## 5. Constraints & Business Rules (enforced di DB when possible)

1. **Single active membership per user** (business rule)

   * Enforced in application logic OR with partial unique index:

     ```sql
     CREATE UNIQUE INDEX one_active_membership_per_user ON memberships(user_id) WHERE status = 'active';
     ```
   * Hati-hati: pastikan workflow update membership (expire old before inserting new) tidak melanggar constraint.

2. **Automatic expiry**

   * Gunakan scheduled job (Supabase cron / Edge Function) untuk set `status = 'expired'` where `end_date < current_date`.

3. **Valid video embed URL**

   * Validasi di aplikasi (whitelist domains: youtube.com, youtu.be, vimeo.com, supabase storage)

4. **Payments must reference membership (optional)**

   * `membership_id` nullable but recommended to link payment for audit.

---

## 6. Row-Level Security (RLS) Recommendations (Supabase)

> Admins are managed by Supabase Auth — admin role stored in `auth` JWT claims.

* **Enable RLS** on `users`, `memberships`, `payments`, `courses`.

### Example policies

* `users` table:

  * Allow read for users with `role = 'admin'` (from JWT)
  * Allow insert/update/delete for admin only

* `memberships`:

  * Admin can full access
  * Optionally allow users to read their own memberships (if members later allowed to login)

* `courses`:

  * Public read (if courses free) OR require membership check via function

> Implement policies using `auth.role` claim or `app_metadata` in Supabase.

---

## 7. Sample SQL (CREATE TABLE snippets)

```sql
-- extension for uuid generation
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  full_name text NOT NULL,
  email text,
  phone text,
  joined_date date,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE membership_plans (
  id serial PRIMARY KEY,
  name text NOT NULL,
  price numeric(12,2) NOT NULL DEFAULT 0,
  duration_days integer NOT NULL,
  description text,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE memberships (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) ON DELETE CASCADE,
  plan_id integer REFERENCES membership_plans(id) ON DELETE SET NULL,
  start_date date NOT NULL,
  end_date date NOT NULL,
  status text NOT NULL CHECK (status IN ('active','expired')),
  created_at timestamptz DEFAULT now()
);

CREATE TABLE courses (
  id serial PRIMARY KEY,
  title text NOT NULL,
  description text,
  category text,
  video_embed_url text NOT NULL,
  thumbnail_url text,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE payments (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) ON DELETE CASCADE,
  membership_id uuid REFERENCES memberships(id) ON DELETE SET NULL,
  amount numeric(12,2) NOT NULL,
  method text,
  receipt_url text,
  paid_at timestamptz,
  created_at timestamptz DEFAULT now()
);
```

---

## 8. Migration & Versioning Notes

* Letakkan SQL di `/db/migrations`.
* Prefer using a migration tool (pg-migrate, Flyway, or Supabase SQL migrations).
* Include `down` migration when using migration frameworks.

---

## 9. Next Steps (opsional)</n1. Saya bisa generate file `ERD.png` (visual) jika mau.

2. Saya bisa buatkan SQL migration file lengkap untuk Supabase.
3. Saya bisa buatkan RLS policy SQL dan contoh policy statements.

---

*Dokumen ini dibuat untuk FitTrack — jika mau ada kolom tambahan (mis. `role` di users, atau `is_active` di courses), bilang saja, saya update.*

